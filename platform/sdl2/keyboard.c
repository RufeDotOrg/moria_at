// Rufe.org LLC 2022-2025: ISC License
DATA char* scancode_mapD;
// Case toggle
DATA uint8_t toggleD[128] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x05, 0x10,
    0x10, 0x10, 0x11, 0x05, 0x11, 0x19, 0x12, 0x16, 0x10, 0x72, 0x10, 0x10,
    0x19, 0x10, 0x72, 0x10, 0x10, 0x10, 0x68, 0x11, 0x12, 0x11, 0x01, 0x01,
    0x10, 0x16, 0x10, 0x10, 0x72, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x68, 0x72,
    0x1e, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x1e, 0x00,
};

int
keyboard_map(scancode)
char* scancode;
{
  scancode_mapD = scancode;
}

// (0x1d 29 bytes) compact switch table
STATIC char
gamesym_by_scancode(code)
{
  switch (code) {
    case SDL_SCANCODE_RETURN:
      return '\n';
    case SDL_SCANCODE_KP_1 ... SDL_SCANCODE_KP_9:
      return '1' + (code - SDL_SCANCODE_KP_1);
    case SDL_SCANCODE_KP_0:
      return '0';
    case SDL_SCANCODE_KP_ENTER:
      return '\n';
    case SDL_SCANCODE_KP_PLUS:
      return '+';
    case SDL_SCANCODE_KP_MINUS:
      return '-';
    case SDL_SCANCODE_KP_PERIOD:
      return '.';
    case SDL_SCANCODE_KP_MULTIPLY:
      return '*';
    case SDL_SCANCODE_KP_DIVIDE:
      return '/';
  }

  return 0;
}

int
sdl_keyboard_event(event)
SDL_Event event;
{
  int sym;
  int mod = event.key.keysym.mod;

  // Scancode override:
  // Gameplay mode raw inputs
  // Player customization
  if (scancode_mapD) {
    uint8_t scancode = MIN(event.key.keysym.scancode, 255);
    sym = scancode_mapD[scancode];
    // require numlock off (due to Windows Shift+Numlock complexity)
    if (mod & KMOD_NUM) sym = 0;
  } else {
    // Common text input
    sym = event.key.keysym.sym;
    if (sym >= SDLK_SCANCODE_MASK) {
      sym = gamesym_by_scancode(event.key.keysym.scancode);
    }
  }

  // Compression (TBD customization or mode toggle)
  if (mod & KMOD_SHIFT) {
    if (sym < AL(toggleD)) sym ^= toggleD[sym];
  }

  if (mod & KMOD_CTRL) {
    if (char_alpha(sym)) sym = CTRL(sym);
  }

  return sym;
}

#define KEYBOARD 1
